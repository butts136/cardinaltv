{% extends "diaporama_base.html" %}

{% block title %}Nouvelles RSS ¬∑ Cardinal TV{% endblock %}

{% block page_title %}Nouvelles{% endblock %}
{% block page_subtitle %}
  <p class="page-subtitle">Configurez l'affichage des derni√®res nouvelles depuis des flux RSS.</p>
{% endblock %}
{% block header_actions %}
  <a href="{{ url_for('main.slideshow_overview') }}" class="secondary-button">Vue g√©n√©rale</a>
{% endblock %}

{% block content %}
  <section class="card news-section" id="news-section">
    <div class="section-header">
      <div>
        <h2>Diapositive Nouvelles üì∞</h2>
        <p class="playlist-subtitle">Affichez les derni√®res nouvelles en d√©filement automatique.</p>
      </div>
      <div class="custom-toggle-control">
        <label class="visibility-toggle">
          <span class="visibility-toggle-label visibility-toggle-label-on">Activ√©e</span>
          <div class="visibility-toggle-switch">
            <input id="news-enabled" class="visibility-toggle-checkbox" type="checkbox" aria-label="Activer la diapo" />
            <span class="visibility-toggle-slider"></span>
          </div>
          <span class="visibility-toggle-label visibility-toggle-label-off">D√©sactiv√©e</span>
        </label>
      </div>
    </div>

    <div class="section-content">
      <div class="form-row dual">
        <div>
          <label for="news-scroll-delay">D√©lai avant d√©filement (sec)</label>
          <input type="number" id="news-scroll-delay" min="0.5" max="30" step="0.5" value="3" />
          <p class="field-hint">Temps d'attente avant que le d√©filement commence.</p>
        </div>
        <div>
          <label for="news-scroll-speed">Vitesse de d√©filement</label>
          <input type="range" id="news-scroll-speed" min="10" max="200" step="10" value="50" />
          <span id="news-scroll-speed-value" class="range-value">50</span>
          <p class="field-hint">Plus la valeur est √©lev√©e, plus le d√©filement est rapide.</p>
        </div>
        <div>
          <label for="news-max-items">Nombre max de nouvelles</label>
          <input type="number" id="news-max-items" min="1" max="50" step="1" value="10" />
          <p class="field-hint">Nombre maximum de nouvelles √† afficher.</p>
        </div>
      </div>
      
      <div class="birthday-preview-actions">
        <button type="button" class="primary-button" id="news-save">Enregistrer</button>
        <span id="news-status" class="upload-feedback" aria-live="polite"></span>
      </div>
    </div>
  </section>

  <section class="card rss-feeds-section" id="rss-feeds-section">
    <div class="section-header">
      <div>
        <h2>Flux RSS</h2>
        <p class="playlist-subtitle">G√©rez les sources de nouvelles RSS.</p>
      </div>
      <button type="button" class="secondary-button" id="add-feed-btn">Ajouter un flux</button>
    </div>

    <div class="section-content">
      <div id="feeds-list" class="feeds-list">
        <!-- Les flux seront charg√©s dynamiquement -->
      </div>
    </div>
  </section>

  <!-- Section Scrapers -->
  <section class="card scrapers-section" id="scrapers-section">
    <div class="section-header">
      <div>
        <h2>üåê Sources Web (Scraper)</h2>
        <p class="playlist-subtitle">Analysez et r√©cup√©rez les nouvelles directement depuis des sites web.</p>
      </div>
      <button type="button" class="secondary-button" id="add-scraper-btn">
        <span>‚ûï</span> Ajouter une source
      </button>
    </div>

    <div class="section-content">
      <!-- Analyse de site -->
      <div class="scraper-analyze-section">
        <h3>üîç Analyser un nouveau site</h3>
        <div class="form-row dual">
          <div style="flex:3">
            <label for="scraper-url-input">URL du site de nouvelles</label>
            <input
              type="url"
              id="scraper-url-input"
              placeholder="https://www.lapresse.ca/actualites/"
              autocomplete="off"
            />
          </div>
          <div style="flex:1; display:flex; align-items:flex-end">
            <button type="button" class="primary-button" id="analyze-site-btn">
              Analyser
            </button>
          </div>
        </div>

        <!-- R√©sultats d'analyse -->
        <div id="scraper-analysis-results" class="scraper-analysis-results" style="display:none">
          <div class="analysis-header">
            <h4 id="analysis-site-name">Site analys√©</h4>
            <span id="analysis-articles-count" class="badge">0 articles trouv√©s</span>
          </div>
          <div id="analysis-sample-articles" class="analysis-sample-articles">
            <!-- Articles √©chantillons -->
          </div>
          <div class="analysis-actions">
            <button type="button" class="secondary-button" id="cancel-analysis-btn">Annuler</button>
            <button type="button" class="primary-button" id="confirm-add-scraper-btn">
              Ajouter cette source
            </button>
          </div>
        </div>

        <div id="scraper-analysis-error" class="scraper-analysis-error" style="display:none">
          <span class="error-icon">‚ö†Ô∏è</span>
          <span id="analysis-error-message">Erreur lors de l'analyse</span>
        </div>

        <div id="scraper-analysis-loading" class="scraper-analysis-loading" style="display:none">
          <div class="spinner"></div>
          <span>Analyse du site en cours...</span>
        </div>
      </div>

      <hr style="margin:1.5rem 0; border:none; border-top:1px solid rgba(255,255,255,0.1)">

      <!-- Liste des scrapers -->
      <h3 style="margin-bottom:1rem">üìã Sources configur√©es</h3>
      <div id="scrapers-list" class="scrapers-list">
        <p class="empty-message" id="no-scrapers-message">Aucune source web configur√©e. Analysez un site ci-dessus pour commencer.</p>
      </div>
    </div>
  </section>

  <section class="card news-preview-section" id="news-preview-section">
    <div class="section-header">
      <div>
        <h2>Aper√ßu des nouvelles</h2>
        <p class="playlist-subtitle">Liste des nouvelles (donn√©es) utilis√©es dans la diapositive.</p>
      </div>
      <button type="button" class="secondary-button" id="refresh-news-btn">Rafra√Æchir</button>
    </div>

    <div class="section-content">
      <div id="news-preview" class="news-preview">
        <!-- Les cartes de nouvelles seront charg√©es dynamiquement -->
      </div>
    </div>
  </section>

  <section class="card news-slide-preview-section" id="news-slide-preview-section">
    <div class="section-header">
      <div>
        <h2>Aper√ßu de la diapositive</h2>
        <p class="playlist-subtitle">Visualisez la diapositive Nouvelles telle qu'elle sera affich√©e.</p>
      </div>
      <button type="button" class="secondary-button" data-preview-iframe="news-slide-preview">Rafra√Æchir l'aper√ßu</button>
    </div>

    <div class="section-content">
      <div class="slideshow-frame news-slide-preview-frame">
        <iframe
          id="news-slide-preview"
          class="news-slide-preview-iframe slideshow-preview-iframe"
          title="Aper√ßu diapositive nouvelles"
          loading="lazy"
          src="{{ url_for('main.slideshow') }}?slide=news&preview=1"
        ></iframe>
      </div>
    </div>
  </section>

  <section class="card news-style-section" id="news-style-section">
    <div class="section-header">
      <div>
        <h2>Style des cartes</h2>
        <p class="playlist-subtitle">Personnalisez l'apparence des cartes de nouvelles.</p>
      </div>
    </div>

    <div class="section-content">
      <div class="form-row dual">
        <div>
          <label for="card-bg-color">Couleur de fond</label>
          <input type="color" id="card-bg-color" value="#1a1a2e" />
        </div>
        <div>
          <label for="card-bg-opacity">Opacit√© du fond</label>
          <input type="range" id="card-bg-opacity" min="0" max="1" step="0.1" value="0.9" />
          <span id="card-bg-opacity-value" class="range-value">90%</span>
        </div>
        <div>
          <label for="card-title-color">Couleur du titre</label>
          <input type="color" id="card-title-color" value="#ffffff" />
        </div>
        <div>
          <label for="card-time-color">Couleur de l'heure</label>
          <input type="color" id="card-time-color" value="#a3a3a3" />
        </div>
      </div>
      <div class="form-row dual">
        <div>
          <label for="card-title-size">Taille du titre (px)</label>
          <input type="number" id="card-title-size" min="12" max="72" step="1" value="28" />
        </div>
        <div>
          <label for="card-time-size">Taille de l'heure (px)</label>
          <input type="number" id="card-time-size" min="10" max="48" step="1" value="18" />
        </div>
        <div>
          <label for="card-source-size">Taille de la source (px)</label>
          <input type="number" id="card-source-size" min="10" max="48" step="1" value="16" />
        </div>
        <div>
          <label for="card-description-size">Taille de la description (px)</label>
          <input type="number" id="card-description-size" min="10" max="36" step="1" value="16" />
        </div>
      </div>
      <div class="form-row dual">
        <div>
          <label for="card-width">Largeur des cartes (%)</label>
          <input type="number" id="card-width" min="50" max="100" step="5" value="90" />
        </div>
        <div>
          <label for="card-height">Hauteur des cartes (%)</label>
          <input type="number" id="card-height" min="15" max="50" step="5" value="25" />
        </div>
        <div>
          <label for="cards-per-row">Cartes par ligne</label>
          <input type="number" id="cards-per-row" min="1" max="4" step="1" value="1" />
        </div>
        <div>
          <label class="live-editor-date-toggle" for="show-image">
            <input id="show-image" type="checkbox" checked />
            Afficher les images
          </label>
        </div>
        <div>
          <label for="news-image-width">Largeur image (px)</label>
          <input type="number" id="news-image-width" min="0" max="500" step="5" value="0" />
          <p class="field-hint">0 pour automatique.</p>
        </div>
        <div>
          <label for="news-image-height">Hauteur image (px)</label>
          <input type="number" id="news-image-height" min="0" max="500" step="5" value="0" />
          <p class="field-hint">0 pour automatique.</p>
        </div>
        <div>
          <label class="live-editor-date-toggle" for="show-time">
            <input id="show-time" type="checkbox" checked />
            Afficher l'heure
          </label>
        </div>
      </div>
    </div>
  </section>

  <!-- Modal d'ajout de flux -->
  <div id="add-feed-modal" class="modal" hidden>
    <div class="modal-overlay"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3>Ajouter un flux RSS</h3>
        <button type="button" class="modal-close" aria-label="Fermer">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <label for="new-feed-name">Nom du flux</label>
          <input type="text" id="new-feed-name" placeholder="ex: Radio-Canada" />
        </div>
        <div class="form-row">
          <label for="new-feed-url">URL du flux RSS</label>
          <input type="url" id="new-feed-url" placeholder="https://example.com/rss" />
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="secondary-button" id="cancel-feed-btn">Annuler</button>
        <button type="button" class="primary-button" id="confirm-feed-btn">Ajouter</button>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/news_editor.js') }}"></script>
{% endblock %}
